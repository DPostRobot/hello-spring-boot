name: API Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Start application
        run: |
          echo "Starting Python Flask application..."
          python app.py > app.log 2>&1 &
          APP_PID=$!
          echo "Application started with PID: $APP_PID"
          echo "Waiting 10 seconds for initial startup..."
          sleep 10
          echo "Checking if application process is still running..."
          if ! ps -p $APP_PID > /dev/null; then
            echo "ERROR: Application process died during startup!"
            echo "=== Application Logs ==="
            cat app.log || true
            exit 1
          fi
          echo "Application process is running (PID: $APP_PID)"
        env:
          FLASK_ENV: test
          FLASK_PORT: 5000
      
      - name: Wait for application to be ready
        run: |
          echo "Waiting for application to be ready..."
          timeout=120
          elapsed=0
          while ! curl -f http://localhost:5000/health 2>/dev/null; do
            if [ $elapsed -ge $timeout ]; then
              echo "ERROR: Application failed to start within $timeout seconds"
              echo "=== Checking application status ==="
              ps aux | grep python | grep app.py || true
              echo "=== Checking if port 5000 is listening ==="
              netstat -tlnp | grep 5000 || ss -tlnp | grep 5000 || true
              echo "=== Application Logs (last 50 lines) ==="
              tail -50 app.log || true
              echo "=== Trying to access root endpoint ==="
              curl -v http://localhost:5000/ || true
              exit 1
            fi
            echo "Waiting for application... (elapsed: ${elapsed}s)"
            sleep 2
            elapsed=$((elapsed + 2))
          done
          echo "Application is ready! Health check passed."
          echo "=== Application Logs (last 20 lines) ==="
          tail -20 app.log || true
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Run API tests
        id: test
        run: |
          node test-runner.js test_case.json
      
      - name: Send test results to backend
        if: always()
        run: |
          if [ -f test_results.json ]; then
            echo "Sending test results to backend..."
            REPO_URL="${{ github.repository }}"
            ORG="${{ github.repository_owner }}"
            WORKFLOW_RUN_ID="${{ github.run_id }}"
            WORKFLOW_RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            
            # Build JSON payload using jq
            PAYLOAD=$(jq -n \
              --arg repo_url "https://github.com/$REPO_URL" \
              --arg org "$ORG" \
              --arg workflow_run_id "$WORKFLOW_RUN_ID" \
              --arg workflow_run_url "$WORKFLOW_RUN_URL" \
              --slurpfile test_results test_results.json \
              '{repo_url: $repo_url, org: $org, workflow_run_id: $workflow_run_id, workflow_run_url: $workflow_run_url, test_results: $test_results[0]}')
            
            curl -X POST "${{ env.backend_api_url }}/repos/test-results" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD" || echo "Failed to send test results, but continuing..."
          else
            echo "test_results.json not found, skipping..."
          fi
        env:
          backend_api_url: 150.158.113.67:8000
      
      - name: Stop application
        if: always()
        run: pkill -f "python.*app.py"
